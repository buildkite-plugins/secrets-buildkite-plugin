#!/bin/bash
set -euo pipefail

calculate_backoff_delay() {
  local BASE_DELAY="$1"
  local ATTEMPT="$2"
  local DELAY=$((BASE_DELAY * (2 ** (ATTEMPT - 1))))
  local JITTER=$((RANDOM % (DELAY / 4 + 1)))
  local TOTAL_DELAY=$((DELAY + JITTER))

  if [ "$TOTAL_DELAY" -gt 60 ]; then
    TOTAL_DELAY=60
  fi

  echo "$TOTAL_DELAY"
}

buildkite_agent_secret_get_with_retry() {
  local KEY="$1"
  local MAX_ATTEMPTS="${BUILDKITE_PLUGIN_SECRETS_RETRY_MAX_ATTEMPTS:-5}"
  local BASE_DELAY="${BUILDKITE_PLUGIN_SECRETS_RETRY_BASE_DELAY:-2}"
  local ATTEMPT=1
  local EXIT_CODE
  local OUTPUT

  while [ "$ATTEMPT" -le "$MAX_ATTEMPTS" ]; do
    set +e
    OUTPUT=$(buildkite-agent secret get "${KEY}" 2>&1)
    EXIT_CODE=$?
    set -e

    if [ "$EXIT_CODE" -eq 0 ]; then
      echo "$OUTPUT"
      return 0
    fi

    if echo "$OUTPUT" | grep -qiE "(not found|unauthorized|forbidden|bad request)"; then
      echo "$OUTPUT"
      return "$EXIT_CODE"
    fi

    if [ "$ATTEMPT" -lt "$MAX_ATTEMPTS" ]; then
      local TOTAL_DELAY
      TOTAL_DELAY=$(calculate_backoff_delay "$BASE_DELAY" "$ATTEMPT")

      echo "Failed to fetch secret $KEY (attempt $ATTEMPT/$MAX_ATTEMPTS). Retrying in ${TOTAL_DELAY}s..." >&2
      echo "Error: $OUTPUT" >&2

      sleep "$TOTAL_DELAY"
      ATTEMPT=$((ATTEMPT + 1))
    else
      echo "Failed to fetch secret $KEY after $MAX_ATTEMPTS attempts" >&2
      echo "Error: $OUTPUT" >&2
      return "$EXIT_CODE"
    fi
  done
}

# downloads the secret by provided key using the buildkite-agent secret command
downloadSecret() {
    local key=$1

    if ! secret=$(buildkite_agent_secret_get_with_retry "${key}"); then
        echo "not found ${key}"
    else
        echo "${secret}"
    fi

}

# decodes a base64 encoded secret, expects decoded secret to be in the format KEY=value:
# FOO=BAR
# BAR=BAZ
decodeSecrets() {
    local encoded_secret=$1
    envscript=''

    while IFS='=' read -r key value
        do
            # Check if both key and value are non-empty
            if [ -n "$key" ] && [ -n "$value" ]; then
                # Update envscript
                envscript+="${key}=${value}"$'\n'
            fi
    done <<< "$(echo "$encoded_secret" | base64 -d)"

    echo "$envscript"
}

# decodes the base64 encoded secret passed in args, and exports the decoded secrets
# into the environment via the envscript variable
processSecrets() {
    local encoded_secret=$1
    local envscript=''

    if ! envscript=$(decodeSecrets "${encoded_secret}"); then
        echo "âš ï¸ Unable to decode secrets"
        exit 1
    fi

    # I don't think this echo is really needed outside of debugging during development
    # so going to comment out for now and we can always re-evaluate it's usefulness later
    # echo "Evaluating ${#envscript} bytes of env"
    set -o allexport
    eval "$envscript"
    set +o allexport
}

processVariables() {
  # Extract the environment variable keys and Buildkite secret paths.
  for param in ${!BUILDKITE_PLUGIN_SECRETS_VARIABLES_*}; do
    key="${param/BUILDKITE_PLUGIN_SECRETS_VARIABLES_/}"
    path="${!param}"

    if ! value=$(buildkite_agent_secret_get_with_retry "${path}"); then
        echo "âš ï¸ Unable to find secret at ${path}"
        exit 1
    else
        export "${key}=${value}"
    fi
  done
}

# primarily used for debugging; The job log will show what env vars have changed after this hook is executed
dumpEnvSecrets() {
  if [[ "${BUILDKITE_PLUGIN_SECRETS_DUMP_ENV:-}" =~ ^(true|1)$ ]] ; then
    echo "~~~ ðŸ”Ž Environment variables that were set" >&2;
    comm -13 <(echo "$env_before") <(env | sort) || true
  fi
}


env_before="$(env | sort)" # used by


echo "ðŸ” Fetching env secrets from Buildkite secrets"
# If we are using a specific key we should download and evaluate it
if [[ -n "${BUILDKITE_PLUGIN_SECRETS_ENV:-env}" ]]; then
    secret=$(downloadSecret "${BUILDKITE_PLUGIN_SECRETS_ENV:-env}")
    if [[ "${secret}" =~ "not found" ]]; then
        echo "No secret found at ${BUILDKITE_PLUGIN_SECRETS_ENV:-env}"
    else
        processSecrets "${secret}"
    fi
fi

# Now download and set ENV specified using the `variables` plugin param
processVariables

dumpEnvSecrets
